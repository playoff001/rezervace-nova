â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  DEFINITIVNÃ OPRAVA SSL PRO IPv6 - RYCHLÃ NÃVOD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLÃ‰M:
- IPv4 funguje OK (Let's Encrypt certifikÃ¡t)
- IPv6 pouÅ¾Ã­vÃ¡ self-signed certifikÃ¡t â†’ varovÃ¡nÃ­ o nebezpeÄÃ­
- Polovina uÅ¾ivatelÅ¯ dostÃ¡vÃ¡ varovÃ¡nÃ­

Å˜EÅ ENÃ:
SpusÅ¥ tyto pÅ™Ã­kazy na serveru (zkopÃ­ruj a vloÅ¾ celÃ½ blok najednou):

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  KROK 1: PÅ™ipoj se na server
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ssh root@aplikace.eu
# Heslo: tnpKksN4TkkA

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  KROK 2: ZkopÃ­ruj a spusÅ¥ tento celÃ½ blok pÅ™Ã­kazÅ¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DOMAIN="aplikace.eu"
CONFIG_FILE=$(grep -l "$DOMAIN" /etc/nginx/sites-enabled/* 2>/dev/null | head -1)
[ -z "$CONFIG_FILE" ] && CONFIG_FILE="/etc/nginx/sites-enabled/default"

echo "=== ZÃLOHA ==="
cp "$CONFIG_FILE" "${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
echo "âœ… ZÃ¡loha vytvoÅ™ena"

echo ""
echo "=== VYTVOÅ˜ENÃ CERTIFIKÃTU ==="
if ! command -v certbot &> /dev/null; then
    apt update && apt install -y certbot python3-certbot-nginx
fi

certbot --nginx -d aplikace.eu -d www.aplikace.eu \
    --non-interactive \
    --agree-tos \
    --email admin@aplikace.eu \
    --redirect \
    --force-renewal

CERT_PATH="/etc/letsencrypt/live/aplikace.eu/fullchain.pem"
if [ ! -f "$CERT_PATH" ]; then
    echo "âŒ CertifikÃ¡t nebyl vytvoÅ™en!"
    exit 1
fi
echo "âœ… CertifikÃ¡t vytvoÅ™en: $CERT_PATH"

echo ""
echo "=== ÃšPRAVA NGINX KONFIGURACE ==="
echo "KonfiguraÄnÃ­ soubor: $CONFIG_FILE"

# Zkontroluj, zda mÃ¡ IPv6 sprÃ¡vnÃ½ certifikÃ¡t
if grep -q "listen \[::\]:443" "$CONFIG_FILE"; then
    echo "âœ… IPv6 listen nalezen"
    # OvÄ›Å™ certifikÃ¡t
    if ! grep -A 5 "listen \[::\]:443" "$CONFIG_FILE" | grep -q "ssl_certificate.*aplikace.eu"; then
        echo "âš ï¸ IPv6 nemÃ¡ sprÃ¡vnÃ½ certifikÃ¡t - upravuji..."
        # Uprav konfiguraci - pÅ™idej certifikÃ¡t pro IPv6
        sed -i '/listen \[::\]:443 ssl http2;/a\    ssl_certificate /etc/letsencrypt/live/aplikace.eu/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/aplikace.eu/privkey.pem;' "$CONFIG_FILE"
    fi
else
    echo "âš ï¸ IPv6 listen chybÃ­ - pÅ™idÃ¡vÃ¡m..."
    sed -i '/listen 443 ssl http2;/a\    listen [::]:443 ssl http2;' "$CONFIG_FILE"
fi

echo ""
echo "=== TEST A RESTART ==="
if nginx -t; then
    systemctl restart nginx
    echo "âœ… Nginx restartovÃ¡n"
else
    echo "âŒ Chyba v konfiguraci!"
    exit 1
fi

echo ""
echo "=== OVÄšÅ˜ENÃ ==="
echo "IPv4 certifikÃ¡t:"
echo | openssl s_client -connect aplikace.eu:443 -servername aplikace.eu 2>/dev/null | openssl x509 -noout -subject -issuer 2>/dev/null | head -2
echo ""
echo "IPv6 certifikÃ¡t:"
echo | openssl s_client -connect [2a00:4b40:aaaa:2011:0:0:0:6]:443 -servername aplikace.eu 2>/dev/null | openssl x509 -noout -subject -issuer 2>/dev/null | head -2

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… HOTOVO!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“‹ DalÅ¡Ã­ kroky:"
echo "1. PoÄkej 5-10 minut (DNS cache)"
echo "2. Otestuj: https://www.ssllabs.com/ssltest/analyze.html?d=aplikace.eu"
echo "3. OÄekÃ¡vanÃ½ vÃ½sledek: Grade A pro IPv4 i IPv6"
echo ""

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CO DÄšLAT, KDYÅ½ TO NEFUNGUJE?
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Pokud mÃ¡Å¡ problÃ©m, spusÅ¥ tento diagnostickÃ½ pÅ™Ã­kaz:

cat "$CONFIG_FILE" | grep -A 10 "listen \[::\]:443"

MÄ›lo by ukÃ¡zat nÄ›co jako:

    listen [::]:443 ssl http2;
    ssl_certificate /etc/letsencrypt/live/aplikace.eu/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/aplikace.eu/privkey.pem;

Pokud tam nenÃ­ "ssl_certificate", pak IPv6 pouÅ¾Ã­vÃ¡ Å¡patnÃ½ certifikÃ¡t!

RUÄŒNÃ OPRAVA:
1. OtevÅ™i konfiguraci: nano "$CONFIG_FILE"
2. Najdi Å™Ã¡dek s "listen [::]:443 ssl http2;"
3. Hned pod nÄ›j pÅ™idej:
   ssl_certificate /etc/letsencrypt/live/aplikace.eu/fullchain.pem;
   ssl_certificate_key /etc/letsencrypt/live/aplikace.eu/privkey.pem;
4. UloÅ¾: Ctrl+O, Enter, Ctrl+X
5. Test: nginx -t
6. Restart: systemctl restart nginx

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


